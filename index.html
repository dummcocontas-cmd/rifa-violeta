import React, { useState, useEffect } from 'react';
import { Heart, Shield, ShoppingCart, Trash2, X } from 'lucide-react';

// üî• COLE AQUI SUA CONFIGURA√á√ÉO DO FIREBASE
const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "seu-projeto.firebaseapp.com",
  projectId: "seu-projeto-id",
  storageBucket: "seu-projeto.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abc123"
};

export default function RifaVioleta() {
  const [view, setView] = useState('home');
  const [numeros, setNumeros] = useState({});
  const [carrinho, setCarrinho] = useState([]);
  const [adminPassword, setAdminPassword] = useState('');
  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({ disponiveis: 300, reservados: 0, pagos: 0 });
  const [firebaseReady, setFirebaseReady] = useState(false);
  const [db, setDb] = useState(null);
  const [mostrarCarrinho, setMostrarCarrinho] = useState(false);

  const WHATSAPP = '5514997432961';
  const PIX = '14 99743-2961';
  const META = 6180;

  useEffect(() => {
    const initFirebase = async () => {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, collection, doc, setDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        setDb(firestore);
        setFirebaseReady(true);

        const numerosRef = collection(firestore, 'numeros');
        
        onSnapshot(numerosRef, async (snapshot) => {
          if (snapshot.empty) {
            const inicial = {};
            for (let i = 1; i <= 300; i++) {
              inicial[i] = { status: 'disponivel', nome: '', contato: '' };
              await setDoc(doc(firestore, 'numeros', String(i)), inicial[i]);
            }
            setNumeros(inicial);
            calculateStats(inicial);
          } else {
            const dados = {};
            snapshot.forEach((doc) => {
              dados[doc.id] = doc.data();
            });
            setNumeros(dados);
            calculateStats(dados);
          }
          setLoading(false);
        }, (error) => {
          usarModoLocal();
        });

      } catch (error) {
        usarModoLocal();
      }
    };

    initFirebase();
  }, []);

  const usarModoLocal = async () => {
    try {
      const result = await window.storage.get('rifa-violeta-numeros');
      if (result && result.value) {
        const data = JSON.parse(result.value);
        setNumeros(data);
        calculateStats(data);
      } else {
        const inicial = {};
        for (let i = 1; i <= 300; i++) {
          inicial[i] = { status: 'disponivel', nome: '', contato: '' };
        }
        setNumeros(inicial);
        await window.storage.set('rifa-violeta-numeros', JSON.stringify(inicial));
        calculateStats(inicial);
      }
    } catch (error) {
      const inicial = {};
      for (let i = 1; i <= 300; i++) {
        inicial[i] = { status: 'disponivel', nome: '', contato: '' };
      }
      setNumeros(inicial);
      calculateStats(inicial);
    }
    setLoading(false);
  };

  const calculateStats = (data) => {
    const stats = { disponiveis: 0, reservados: 0, pagos: 0 };
    Object.values(data).forEach(num => {
      if (num.status === 'disponivel') stats.disponiveis++;
      else if (num.status === 'reservado') stats.reservados++;
      else if (num.status === 'pago') stats.pagos++;
    });
    setStats(stats);
  };

  const atualizarNumero = async (numero, novoStatus) => {
    if (firebaseReady && db) {
      try {
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const numeroDoc = doc(db, 'numeros', String(numero));
        await setDoc(numeroDoc, {
          status: novoStatus,
          nome: numeros[numero].nome || '',
          contato: numeros[numero].contato || '',
          atualizadoEm: new Date().toISOString()
        });
      } catch (error) {
        const novosNumeros = {
          ...numeros,
          [numero]: { ...numeros[numero], status: novoStatus }
        };
        setNumeros(novosNumeros);
        await window.storage.set('rifa-violeta-numeros', JSON.stringify(novosNumeros));
        calculateStats(novosNumeros);
      }
    } else {
      const novosNumeros = {
        ...numeros,
        [numero]: { ...numeros[numero], status: novoStatus }
      };
      setNumeros(novosNumeros);
      await window.storage.set('rifa-violeta-numeros', JSON.stringify(novosNumeros));
      calculateStats(novosNumeros);
    }
  };

  const adicionarAoCarrinho = (numero) => {
    if (!carrinho.includes(numero)) {
      setCarrinho([...carrinho, numero]);
    }
  };

  const removerDoCarrinho = (numero) => {
    setCarrinho(carrinho.filter(n => n !== numero));
  };

  const finalizarCompra = () => {
    if (carrinho.length === 0) {
      alert('Adicione pelo menos um n√∫mero ao carrinho!');
      return;
    }
    
    const numerosOrdenados = [...carrinho].sort((a, b) => a - b);
    const total = carrinho.length * 20;
    const mensagem = `Oi! Quero participar da Rifa Solid√°ria da Violeta üê∂üíñ\n\nEscolhi ${carrinho.length} n√∫mero(s): ${numerosOrdenados.join(', ')}\n\nTotal: R$ ${total.toLocaleString('pt-BR')}\n\nAguardo instru√ß√µes para o pagamento!`;
    window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(mensagem)}`, '_blank');
  };

  const getCorStatus = (status) => {
    if (status === 'disponivel') return 'bg-green-500 hover:bg-green-600';
    if (status === 'reservado') return 'bg-yellow-500 cursor-not-allowed';
    if (status === 'pago') return 'bg-blue-500 cursor-not-allowed';
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-pink-50 flex items-center justify-center">
        <div className="text-2xl text-pink-600">Carregando...</div>
      </div>
    );
  }

  // HOME VIEW
  if (view === 'home') {
    return (
      <div className="min-h-screen bg-pink-50">
        <div className="bg-white shadow-md">
          <div className="container mx-auto px-4 py-6">
            <h1 className="text-4xl font-bold text-center text-gray-800" style={{ fontFamily: 'cursive' }}>
              Rifa Solid√°ria
            </h1>
            <div className="w-32 mx-auto border-t-2 border-gray-800 mt-2"></div>
          </div>
        </div>

        <div className="container mx-auto px-4 py-8 max-w-4xl">
          {/* Card da Violeta */}
          <div className="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <div className="flex flex-col md:flex-row gap-6 items-center">
              <div className="w-32 h-32 rounded-full flex-shrink-0 overflow-hidden border-4 border-pink-300 shadow-lg bg-gray-100">
                <img 
                  src="https://i.imgur.com/BggULPB.jpeg" 
                  alt="Violeta"
                  className="w-full h-full object-cover"
                  loading="eager"
                  onError={(e) => {
                    e.target.onerror = null;
                    e.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23ec4899'/%3E%3C/svg%3E";
                  }}
                />
              </div>
              <div className="flex-1 text-center md:text-left">
                <h2 className="text-2xl font-bold text-gray-800 mb-3">Ajude a Violeta</h2>
                <p className="text-gray-700 leading-relaxed">
                  Cachorrinha SRD abandonada em Bauru-SP com fratura na coluna e doen√ßa do carrapato. 
                  Precisa de cirurgia urgente no valor de <strong className="text-pink-600">R$ 6.880,00</strong>.
                </p>
              </div>
            </div>
          </div>

          {/* Estat√≠sticas */}
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="bg-white rounded-xl shadow-md p-4 text-center">
              <div className="text-2xl font-bold text-green-600">{stats.disponiveis}</div>
              <div className="text-xs text-gray-600">Dispon√≠veis</div>
            </div>
            <div className="bg-white rounded-xl shadow-md p-4 text-center">
              <div className="text-2xl font-bold text-yellow-600">{stats.reservados}</div>
              <div className="text-xs text-gray-600">Reservados</div>
            </div>
            <div className="bg-white rounded-xl shadow-md p-4 text-center">
              <div className="text-2xl font-bold text-blue-600">{stats.pagos}</div>
              <div className="text-xs text-gray-600">Pagos</div>
            </div>
          </div>

          {/* Progresso */}
          <div className="bg-white rounded-xl shadow-md p-6 mb-6">
            <div className="flex justify-between text-sm text-gray-600 mb-2">
              <span className="font-bold text-pink-600">R$ {(stats.pagos * 20).toLocaleString('pt-BR')}</span>
              <span>Meta: R$ {META.toLocaleString('pt-BR')}</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-4">
              <div
                className="bg-pink-600 h-4 rounded-full transition-all"
                style={{ width: `${Math.min((stats.pagos * 20 / META) * 100, 100)}%` }}
              />
            </div>
          </div>

          {/* Info R√°pida */}
          <div className="bg-pink-600 text-white rounded-xl shadow-md p-6 mb-6 text-center">
            <p className="text-sm mb-2">Valor por n√∫mero</p>
            <p className="text-3xl font-bold mb-4">R$ 20,00</p>
            <p className="text-sm">Chave Pix: <span className="font-bold">{PIX}</span></p>
          </div>

          {/* Bot√µes */}
          <div className="space-y-3">
            <button
              onClick={() => setView('numeros')}
              className="w-full bg-pink-600 text-white font-bold py-4 rounded-xl shadow-md hover:bg-pink-700 transition-all"
            >
              üéØ Escolher N√∫meros
            </button>
            
            <a
              href="https://www.facebook.com/ajudeavioleta/"
              target="_blank"
              rel="noopener noreferrer"
              className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-md hover:bg-blue-700 transition-all flex items-center justify-center gap-3"
            >
              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              Siga nossa p√°gina no Facebook
            </a>
            
            <button
              onClick={() => setView('admin')}
              className="w-full bg-gray-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-gray-700 transition-all flex items-center justify-center gap-2"
            >
              <Shield className="w-5 h-5" />
              Admin
            </button>
          </div>
        </div>
      </div>
    );
  }

  // N√öMEROS VIEW
  if (view === 'numeros') {
    return (
      <div className="min-h-screen bg-pink-50">
        <div className="bg-white shadow-md sticky top-0 z-10">
          <div className="container mx-auto px-4 py-4">
            <div className="flex items-center justify-between">
              <button
                onClick={() => setView('home')}
                className="text-pink-600 hover:text-pink-800 font-semibold"
              >
                ‚Üê Voltar
              </button>
              <h1 className="text-2xl font-bold text-gray-800">Escolha seus n√∫meros</h1>
              <button
                onClick={() => setMostrarCarrinho(true)}
                className="relative bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700"
              >
                <ShoppingCart className="w-5 h-5" />
                {carrinho.length > 0 && (
                  <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">
                    {carrinho.length}
                  </span>
                )}
              </button>
            </div>
          </div>
        </div>

        <div className="container mx-auto px-4 py-6">
          {/* Legenda */}
          <div className="bg-white rounded-lg shadow-md p-3 mb-4 flex gap-4 justify-center text-sm">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-green-500 rounded"></div>
              <span>Dispon√≠vel</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-yellow-500 rounded"></div>
              <span>Reservado</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-blue-500 rounded"></div>
              <span>Pago</span>
            </div>
          </div>

          {/* Grade de N√∫meros */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <div className="grid grid-cols-10 gap-1">
              {Array.from({ length: 300 }, (_, i) => i + 1).map((num) => {
                const numero = numeros[num];
                const disponivel = numero?.status === 'disponivel';
                const noCarrinho = carrinho.includes(num);
                
                return (
                  <button
                    key={num}
                    onClick={() => {
                      if (disponivel) {
                        if (noCarrinho) {
                          removerDoCarrinho(num);
                        } else {
                          adicionarAoCarrinho(num);
                        }
                      }
                    }}
                    disabled={!disponivel}
                    className={`
                      ${noCarrinho ? 'bg-pink-600 ring-2 ring-pink-800' : getCorStatus(numero?.status || 'disponivel')}
                      text-white font-bold py-2 text-sm
                      transition-all transform
                      ${disponivel ? 'hover:scale-110' : 'opacity-60'}
                    `}
                  >
                    {num}
                  </button>
                );
              })}
            </div>
          </div>
        </div>

        {/* Modal do Carrinho */}
        {mostrarCarrinho && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50">
            <div className="bg-white rounded-t-2xl md:rounded-2xl w-full md:max-w-md max-h-[80vh] overflow-hidden">
              <div className="p-6 border-b flex items-center justify-between">
                <h2 className="text-xl font-bold text-gray-800">Meu Carrinho</h2>
                <button
                  onClick={() => setMostrarCarrinho(false)}
                  className="text-gray-600 hover:text-gray-800"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>
              
              <div className="p-6 overflow-y-auto max-h-[50vh]">
                {carrinho.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">Nenhum n√∫mero selecionado</p>
                ) : (
                  <div className="space-y-2">
                    {carrinho.sort((a, b) => a - b).map((num) => (
                      <div key={num} className="flex items-center justify-between bg-pink-50 p-3 rounded-lg">
                        <span className="font-bold text-gray-800">N√∫mero {num}</span>
                        <div className="flex items-center gap-3">
                          <span className="text-pink-600 font-bold">R$ 20,00</span>
                          <button
                            onClick={() => removerDoCarrinho(num)}
                            className="text-red-500 hover:text-red-700"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {carrinho.length > 0 && (
                <div className="p-6 border-t">
                  <div className="flex justify-between mb-4 text-lg font-bold">
                    <span>Total:</span>
                    <span className="text-pink-600">R$ {(carrinho.length * 20).toLocaleString('pt-BR')}</span>
                  </div>
                  <button
                    onClick={() => {
                      finalizarCompra();
                      setMostrarCarrinho(false);
                    }}
                    className="w-full bg-pink-600 text-white font-bold py-4 rounded-xl hover:bg-pink-700 transition-all"
                  >
                    Enviar para WhatsApp
                  </button>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    );
  }

  // ADMIN VIEW
  if (view === 'admin') {
    if (!isAdmin) {
      return (
        <div className="min-h-screen bg-pink-50 flex items-center justify-center">
          <div className="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full mx-4">
            <button
              onClick={() => setView('home')}
              className="text-pink-600 hover:text-pink-800 font-semibold mb-4"
            >
              ‚Üê Voltar
            </button>
            <h2 className="text-2xl font-bold text-gray-800 mb-6">√Årea Administrativa</h2>
            <input
              type="password"
              placeholder="Senha"
              value={adminPassword}
              onChange={(e) => setAdminPassword(e.target.value)}
              className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-pink-600 outline-none"
              onKeyPress={(e) => e.key === 'Enter' && adminPassword === 'violeta2024' && setIsAdmin(true)}
            />
            <button
              onClick={() => {
                if (adminPassword === 'violeta2024') {
                  setIsAdmin(true);
                } else {
                  alert('Senha incorreta!');
                }
              }}
              className="w-full bg-pink-600 text-white font-bold py-3 rounded-lg hover:bg-pink-700"
            >
              Entrar
            </button>
            <p className="text-xs text-gray-500 mt-4 text-center">Senha padr√£o: violeta2024</p>
          </div>
        </div>
      );
    }

    return (
      <div className="min-h-screen bg-pink-50">
        <div className="bg-white shadow-md">
          <div className="container mx-auto px-4 py-4">
            <button
              onClick={() => { setView('home'); setIsAdmin(false); }}
              className="text-pink-600 hover:text-pink-800 font-semibold mb-2"
            >
              ‚Üê Sair
            </button>
            <h1 className="text-2xl font-bold text-center text-gray-800">Painel Admin</h1>
          </div>
        </div>

        <div className="container mx-auto px-4 py-6">
          <div className="bg-white rounded-xl shadow-md p-4 mb-4">
            <p className="text-sm text-gray-600 mb-4">Clique para mudar status: Verde ‚Üí Amarelo ‚Üí Azul</p>
            <div className="grid grid-cols-10 gap-1">
              {Array.from({ length: 300 }, (_, i) => i + 1).map((num) => {
                const numero = numeros[num];
                
                return (
                  <button
                    key={num}
                    onClick={() => {
                      const novoStatus = 
                        numero?.status === 'disponivel' ? 'reservado' :
                        numero?.status === 'reservado' ? 'pago' :
                        'disponivel';
                      atualizarNumero(num, novoStatus);
                    }}
                    className={`
                      ${getCorStatus(numero?.status || 'disponivel')}
                      text-white font-bold py-2 text-sm
                      hover:scale-110 transition-all transform
                    `}
                  >
                    {num}
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    );
  }
}
